<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アパレルショップ</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <header>
    <h1>アパレルショップ</h1>
    <nav>
      <a href="/">ホーム</a>
      <a href="/products/">商品一覧</a>
      <!-- 管理者用リンク（クライアントにだけ伝える想定） -->
      <a href="/admin/">管理画面</a>
    </nav>

    <!-- ▼ カテゴリナビ -->
    <nav id="categoryNav" class="category-nav" aria-label="カテゴリ">
      <span>カテゴリ：</span>
      <span id="categoryLinks">読み込み中…</span>
    </nav>
    <!-- ▲ カテゴリナビ -->
  </header>

  <main>
    <section>
      <h2>ようこそ！</h2>
      <p>このサイトでは商品情報を管理画面から追加し、ここで公開できます。</p>
      <p>まずは <strong>商品を1件追加</strong> してみましょう！</p>
    </section>

    <!-- ▼ 新着商品エリア -->
    <section id="new-arrivals">
      <h2>New Arrival</h2>
      <div id="newGrid" class="grid"></div>
    </section>
    <!-- ▲ 新着商品エリア -->
  </main>

  <footer>
    <p>&copy; 2025 Apparel Shop</p>
  </footer>

  <!-- Netlify Identity ウィジェット -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("login", () => {
        document.location.href = "/admin/";
      });
    }
  </script>

  <!-- 新着商品スクリプト -->
  <script>
  (async function(){
    try {
      const res = await fetch('/products/products.json', {cache: 'no-store'});
      if(!res.ok) return;
      const data = await res.json();
      const items = (data.items||[]).filter(i => i.published !== false);

      // created_at をタイムスタンプ化（フォールバックは0）
      items.forEach(it => {
        it._ts = it.created_at ? Date.parse(it.created_at) : 0;
      });

      // created_at の降順でソート（新しい順）
      items.sort((a,b) => (b._ts || 0) - (a._ts || 0));

      // 最新4件だけ取得（件数はここで調整可能）
      const list = items.slice(0,4);

      const grid = document.getElementById('newGrid');
      if(!grid) return;
      grid.innerHTML = list.map(it => `
        <a class="card" href="/products/detail.html?id=${encodeURIComponent(it.id)}">
          <img src="${it.image || '/assets/placeholder.png'}" alt="${it.title || ''}">
          <h3>${it.title || 'タイトルなし'}</h3>
          <p class="price">${it.price ? '¥' + Number(it.price).toLocaleString() : ''}</p>
        </a>
      `).join('');

    } catch(e) {
      console.error('new arrivals load error', e);
    }
  })();
  </script>

  <!-- カテゴリナビスクリプト -->
  <script>
  (async function(){
    try {
      const res = await fetch('/products/products.json', {cache: 'no-store'});
      if (!res.ok) { document.getElementById('categoryLinks').textContent = '読み込み失敗'; return; }
      const data = await res.json();
      const items = (data.items || []).filter(i => i.published !== false);
      const cats = [...new Set(items.map(i => i.category).filter(Boolean))];
      const container = document.getElementById('categoryLinks');
      container.innerHTML = '';
      // 全てリンク
      const all = document.createElement('a');
      all.href = '/products/';
      all.textContent = 'すべて';
      container.appendChild(all);
      cats.forEach(c => {
        const a = document.createElement('a');
        a.href = `/products/?category=${encodeURIComponent(c)}`;
        a.textContent = c;
        container.appendChild(a);
      });
    } catch (e) {
      console.error('カテゴリ読み込みエラー', e);
      document.getElementById('categoryLinks').textContent = 'カテゴリ取得エラー';
    }
  })();
  </script>

  <style>
  /* 新着商品の簡単なレイアウト */
  #new-arrivals .grid { display:flex; gap:12px; flex-wrap:wrap; margin-top: 1rem; }
  #new-arrivals .card { width:220px; border:1px solid #eee; padding:8px; text-align:center; border-radius:6px; background:#fff; }
  #new-arrivals .card img { width:100%; height:180px; object-fit:cover; border-radius:4px; }
  #new-arrivals h3 { font-size:1rem; margin:0.5rem 0; }
  #new-arrivals .price { color:#333; font-weight:bold; }

  /* カテゴリナビ */
  .category-nav { margin: 8px 0; font-size:14px; }
  .category-nav a { margin-right:8px; text-decoration:none; color:#1a73e8; }
  .category-nav a:hover { text-decoration:underline; }
  </style>
</body>
</html>
