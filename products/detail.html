<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>商品詳細</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../assets/style.css" />
  <style>
    .detail { max-width:900px; margin:20px auto; display:flex; gap:20px; flex-wrap:wrap; }
    .detail img { width: 100%; max-width:420px; object-fit:contain; border-radius:6px; background:#fff; }
    .info { flex:1; min-width:260px; }
    .price { color:#c0392b; font-weight:700; font-size:1.2rem; margin:8px 0; }
    .sizes select { padding:6px; }
    .related { display:flex; gap:12px; flex-wrap:wrap; margin-top:20px; }
    .related .card { width:160px; border:1px solid #eee; padding:8px; border-radius:6px; text-align:center; }
    #backBtn { background:transparent; border:none; color:#1a73e8; cursor:pointer; padding:6px 0; }
  </style>
</head>
<body>
  <main id="main">
    <p>読み込み中…</p>
  </main>

  <script>
    function getQueryParam(name) {
      const url = new URL(location.href);
      return url.searchParams.get(name);
    }

    // 現在の一覧クエリ（?category=...&sort=... など）を取得しておく
    const currentListQuery = (function(){
      // 参照元のクエリを優先的に保持させるため、まず location.search を使う
      // 例: /products/detail.html?id=tops-001&category=トップス などで飛んできた場合に有効
      // ただし location.search に id=... が含まれることがあるので、id を取り除いたクエリを作る
      const url = new URL(location.href);
      url.searchParams.delete('id');
      const qs = url.searchParams.toString();
      return qs ? '?' + qs : '';
    })();

    function fallbackBack() {
      // 履歴があるなら戻る（一覧からの遷移を想定）
      if (document.referrer && document.referrer.includes('/products')) {
        history.back();
        return;
      }
      // 履歴がない／直接開いた場合は、一覧ページへ（クエリ保持）
      if (currentListQuery) {
        location.href = '/products/' + currentListQuery;
      } else {
        location.href = '/products/';
      }
    }

    async function loadDetail() {
      const url = new URL(location.href);
      const id = url.searchParams.get('id');
      const main = document.getElementById('main');
      if (!id) { main.innerHTML = '<p>商品IDが指定されていません。</p>'; return; }
      try {
        const res = await fetch('/products/products.json', {cache: "no-store"});
        if (!res.ok) throw new Error('読み込み失敗');
        const json = await res.json();
        const items = json.items || [];
        const item = items.find(it => it.id === id);
        if (!item) { main.innerHTML = '<p>商品が見つかりませんでした。</p>'; return; }

        // レンダリング
        main.innerHTML = `
          <div class="detail">
            <div class="media">
              <img src="${item.image || '/assets/placeholder.png'}" alt="${escapeHtml(item.title || '')}">
            </div>
            <div class="info">
              <button id="backBtn">← 一覧へ戻る</button>
              <h1>${escapeHtml(item.title || '')}</h1>
              <p class="price">¥${item.price ? Number(item.price).toLocaleString() : ''}</p>
              <p>${escapeHtml(item.description || '')}</p>

              <div class="sizes">
                <label for="sizeSelect">サイズ：</label>
                <select id="sizeSelect">
                  ${ (item.sizes || []).map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('') || '<option value="">Free</option>'}
                </select>
              </div>

              <div style="margin-top:12px;">
                <button id="addToCart">カートに追加（仮）</button>
                <button id="loginBtn">ログインして購入</button>
              </div>

              <div id="msg" style="margin-top:8px;color:green;"></div>

              <div class="related-block">
                <h3>関連商品</h3>
                <div id="relatedList" class="related"></div>
              </div>
            </div>
          </div>
        `;

        // 戻るボタン
        const backBtn = document.getElementById('backBtn');
        if (backBtn) backBtn.addEventListener('click', () => fallbackBack());

        // add to cart(仮)
        const addBtn = document.getElementById('addToCart');
        if (addBtn) addBtn.addEventListener('click', () => {
          const size = document.getElementById('sizeSelect') ? document.getElementById('sizeSelect').value : null;
          // 仮カートは localStorage へ保存（既存の cart を上書きする方式ではなく push）
          const cart = JSON.parse(localStorage.getItem('simple_cart') || '[]');
          cart.push({ 
  id: item.id, 
  title: item.title, 
  price: item.price, 
  size, 
  qty: 1, 
  image: item.image || '/assets/placeholder.png' 
});

          localStorage.setItem('simple_cart', JSON.stringify(cart));
          const msg = document.getElementById('msg');
          if (msg) msg.textContent = 'カートに追加しました（仮）';
        });

        // ログインボタン（Netlify Identity 呼び出し）
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn) loginBtn.addEventListener('click', () => {
          if (window.netlifyIdentity) {
            window.netlifyIdentity.open();
          } else {
            alert('ログインウィジェットが読み込まれていません。');
          }
        });

        // 関連商品：同カテゴリから3件（自分は除外）
        const related = items.filter(it => it.category === item.category && it.id !== item.id && it.published !== false).slice(0,3);
        const relatedList = document.getElementById('relatedList');
        if (!relatedList) return;
        if (related.length === 0) {
          relatedList.innerHTML = '<p>関連商品はありません。</p>';
        } else {
          // 各関連リンクに現在の一覧クエリを付与しておく（戻るをスムーズにするため）
          relatedList.innerHTML = related.map(r => {
            const qs = currentListQuery || '';
            const href = `detail.html?id=${encodeURIComponent(r.id)}${qs}`;
            return `
              <a class="card" href="${href}">
                <img src="${r.image || '/assets/placeholder.png'}" alt="${escapeHtml(r.title || '')}" style="width:100%;height:80px;object-fit:cover;border-radius:4px">
                <div>${escapeHtml(r.title || '')}</div>
                <div style="color:#c0392b">¥${r.price ? Number(r.price).toLocaleString() : ''}</div>
              </a>
            `;
          }).join('');
        }

      } catch (e) {
        main.innerHTML = '<p>読み込みに失敗しました。</p>';
        console.error(e);
      }
    }

    // 簡単なHTMLエスケープ（表示用）
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    loadDetail();
  </script>
</body>
</html>

